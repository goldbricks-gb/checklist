
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Slot 檢查表預覽</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; }
    .menu button { margin-right: 10px; padding: 5px 15px; }
    #machineTitle { font-size: 24px; font-weight: bold; margin: 20px 0; }
    #signature-container { margin-top: 30px; }
    #signature { border: 1px solid #000; cursor: crosshair; }
  </style>
</head>
<body>
  <h2>請選擇機台</h2>
  <div class="menu">
    <button onclick="loadHtml('Jumbo Slot')">Jumbo Slot</button>
    <button onclick="loadHtml('B Boy')">B Boy</button>
    <button onclick="loadHtml('D27')">D27</button>
    <button onclick="loadHtml('珍寶')">珍寶</button>
    <button onclick="loadHtml('S27')">S27</button>
  </div>

  <div id="machineTitle"></div>
  <iframe id="previewFrame" width="100%" height="1200px" style="border:1px solid #aaa;"></iframe>

  <div id="signature-container">
    <p>請簽名：</p>
    <canvas id="signature" width="400" height="150"></canvas>
    <br>
    <button onclick="clearSignature()">清除簽名</button>
  </div>

  <br>
  <button onclick="savePDF()">儲存 PDF</button>

<script>
  function loadHtml(name) {
    const map = {
      "Jumbo Slot": "static/Jumbo Slot.htm",
      "B Boy": "",
      "D27": "",
      "珍寶": "",
      "S27": ""
    };

    document.getElementById("machineTitle").textContent = name + " 設定值";

    if (map[name]) {
      document.getElementById("previewFrame").src = map[name];
    } else {
      document.getElementById("previewFrame").src = "";
      alert("尚未上傳 " + name + " 資料");
    }
  }

  const canvas = document.getElementById("signature");
  const ctx = canvas.getContext("2d");
  let drawing = false;

  canvas.addEventListener('mousedown', e => {
    drawing = true;
    ctx.beginPath();
    ctx.moveTo(e.offsetX, e.offsetY);
  });
  canvas.addEventListener('mouseup', () => drawing = false);
  canvas.addEventListener('mouseleave', () => drawing = false);
  canvas.addEventListener('mousemove', e => {
    if (!drawing) return;
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
  });

  function clearSignature() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  async function savePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const iframeDoc = document.getElementById("previewFrame").contentDocument || document.getElementById("previewFrame").contentWindow.document;
    const iframeBody = iframeDoc.body;

    const canvasMain = await html2canvas(iframeBody);
    const imgData = canvasMain.toDataURL("image/png");
    const pdfWidth = doc.internal.pageSize.getWidth();
    const pdfHeight = (canvasMain.height * pdfWidth) / canvasMain.width;
    doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

    doc.addPage();
    const signImg = canvas.toDataURL("image/png");
    doc.text("簽名：", 10, 10);
    doc.addImage(signImg, "PNG", 10, 20, 120, 60);

    doc.save("設定檢查表.pdf");
  }
</script>
</body>
</html>
